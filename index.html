<!DOCTYPE html>
<!-- Author: Matthew Richardson -->
<html>

<head>
	<title>Number Space</title>
	<script src="square_mesh_nav.js"></script>
	<script src="polygon_vertices.js"></script>
	<script>

		function onLoad() {

			const canvas = document.getElementById("ns_canvas");
			const context = canvas.getContext("2d");

			canvas.width = innerWidth;
			canvas.height = innerHeight;

			const mouse = { x: 0, y: 0 };

			canvas.onmousemove = function (event) {
				mouse.x = event.clientX;
				mouse.y = event.clientY;
			};

			canvas.onclick = function (event) {
				// debugMode = !debugMode;
				onTile = false;
				tileX = 0;
				tileY = 0;
			};

			const sudokuSquare = tileFace("lightsteelblue");
			const tileT1 = createTile("white", sudokuSquare);
			const tileT2 = createTile("white", sudokuSquare);
			const tileT3 = createTile("white", sudokuSquare);
			const tileT4 = createTile("white", sudokuSquare);
			const tileT5 = createTile("white", sudokuSquare);
			const tileT6 = createTile("white", sudokuSquare);
			const tileT7 = createTile("white", sudokuSquare);
			const tileT8 = createTile("white", sudokuSquare);
			const tileT9 = createTile("white", sudokuSquare);
			tileT1.linkTo(tileT2, getOri(5), getDir(1));
			tileT1.linkTo(tileT3, getOri(0), getDir(2));
			tileT1.linkTo(tileT4, getOri(6), getDir(0));
			tileT2.linkTo(tileT3, getOri(0), getDir(0));
			tileT3.linkTo(tileT4, getOri(0), getDir(0));
			tileT3.linkTo(tileT8, getOri(0), getDir(2));
			tileT5.linkTo(tileT6, getOri(5), getDir(1));
			tileT5.linkTo(tileT7, getOri(0), getDir(2));
			tileT6.linkTo(tileT7, getOri(0), getDir(0));
			tileT6.linkTo(tileT9, getOri(5), getDir(2));
			tileT7.linkTo(tileT8, getOri(0), getDir(0));
			tileT7.linkTo(tileT9, getOri(0), getDir(2));

			const len = 100;
			const midX = (canvas.width - len) / 2;
			const midY = (canvas.height - len) / 2;
			let tileX = 0;
			let tileY = 0;
			const xLim = Math.ceil(midX / len);
			const yLim = Math.ceil(midY / len);
			const walk = startWalk(tileT1, getOri(0));
			let onTile = false;
			const xAxis = { a: { x: 0, y: 0 }, b: { x: 1, y: 0 } };
			const yAxis = { a: { x: 0, y: 0 }, b: { x: 0, y: 1 } };

			function drawScene() {
				const dx = Math.floor((mouse.x - midX) / len) - tileX;
				const dy = Math.floor((mouse.y - midY) / len) - tileY;
				if (onTile) {
					if (dx != 0) {
						if (walk.attempt(getDir(dx > 0 ? 0 : 1))) {
							tileX += dx;
						} else {
							onTile = false;
						}
					} else if (dy != 0) {
						if (walk.attempt(getDir(dy > 0 ? 2 : 3))) {
							tileY += dy;
						} else {
							onTile = false;
						}
					}
				} else if (dx == 0 && dy == 0) {
					onTile = true;
				}
				const pTL = { x: midX + tileX * len, y: midY + tileY * len };
				const limits = [
					xLim - tileX, xLim + tileX,
					yLim - tileY, yLim + tileY
				];
				if (onTile) {
					tileTree(walk, pTL, mouse, len, limits, context);
				} else {
					const midTile = { x: pTL.x + len / 2, y: pTL.y + len / 2 };
					tileTree(walk, pTL, midTile, len, limits, context);
				}
			}

			const times = [];
			let fps;

			function drawInfo() {
				const str = "(" + tileX + ", " + tileY + ") fps: " + fps;
				context.fillText(str, canvas.width - 100, 20);
			}

			(function animate() {
				context.clearRect(0, 0, canvas.width, canvas.height);
				drawScene();
				if (debugMode) {
					const now = performance.now();
					while (times.length > 0 && times[0] <= now - 1000) {
						times.shift();
					}
					times.push(now);
					fps = times.length;
					drawInfo();
				}
				requestAnimationFrame(animate);
			})();

		}

	</script>
</head>

<body onload="onLoad()">
	<canvas id="ns_canvas"></canvas>
	<style>
		* {
			margin: 0;
			padding: 0;
		}
	</style>
</body>

</html>