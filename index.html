<!DOCTYPE html>
<!-- Author: Matthew Richardson -->
<html>

<head>
	<title>Number Space</title>
	<script src="square_mesh_nav.js"></script>
	<script src="polygon_vertices.js"></script>
	<script>

		function onLoad() {

			const canvas = document.getElementById("ns_canvas");
			const context = canvas.getContext("2d");

			canvas.width = innerWidth;
			canvas.height = innerHeight;

			const mouse = { x: 0, y: 0 };

			canvas.onmousemove = function (event) {
				mouse.x = event.clientX;
				mouse.y = event.clientY;
			};

			canvas.onclick = function (event) {
				// debugMode = !debugMode;
				onTile = false;
				tileX = 0;
				tileY = 0;
			};
			const backColor = "#1E1E1E"
			const tileM1 = createTile(backColor, ...sudoTile(3, 0, 0, 0));
			const tileM2 = createTile(backColor, ...sudoTile(1, 0, 0, 4));
			const tileM3 = createTile(backColor, ...sudoTile(4, 0, 0, 0));
			tileM1.linkTo(tileM2, getOri(0), getDir(2));
			tileM1.linkTo(tileM3, getOri(6), getDir(0));
			tileM2.linkTo(tileM3, getOri(0), getDir(0));

			const len = 200;
			const midX = (canvas.width - len) / 2;
			const midY = (canvas.height - len) / 2;
			let tileX = 0;
			let tileY = 0;
			const xLim = Math.ceil(midX / len);
			const yLim = Math.ceil(midY / len);
			const walk = startWalk(tileM1, getOri(0));
			let onTile = false;
			const xAxis = { a: { x: 0, y: 0 }, b: { x: 1, y: 0 } };
			const yAxis = { a: { x: 0, y: 0 }, b: { x: 0, y: 1 } };

			function drawScene() {
				const dx = Math.floor((mouse.x - midX) / len) - tileX;
				const dy = Math.floor((mouse.y - midY) / len) - tileY;
				if (onTile) {
					if (dx != 0) {
						if (walk.attempt(getDir(dx > 0 ? 0 : 1))) {
							tileX += dx;
						} else {
							onTile = false;
						}
					} else if (dy != 0) {
						if (walk.attempt(getDir(dy > 0 ? 2 : 3))) {
							tileY += dy;
						} else {
							onTile = false;
						}
					}
				} else if (dx == 0 && dy == 0) {
					onTile = true;
				}
				const pTL = { x: midX + tileX * len, y: midY + tileY * len };
				const limits = [
					xLim - tileX, xLim + tileX,
					yLim - tileY, yLim + tileY
				];
				walk.currTile().setBaseFillStyle("#505050");
				if (onTile) {
					tileTree(walk, pTL, mouse, len, limits, context);
				} else {
					const midTile = { x: pTL.x + len / 2, y: pTL.y + len / 2 };
					tileTree(walk, pTL, midTile, len, limits, context);
				}
				walk.currTile().setBaseFillStyle(backColor);
			}

			const times = [];
			let fps;

			function drawInfo() {
				const str = "(" + tileX + ", " + tileY + ") fps: " + fps;
				context.fillStyle = "white";
				context.fillText(str, canvas.width - 100, 20);
			}

			(function animate() {
				context.clearRect(0, 0, canvas.width, canvas.height);
				drawScene();
				if (true) {
					const now = performance.now();
					while (times.length > 0 && times[0] <= now - 1000) {
						times.shift();
					}
					times.push(now);
					fps = times.length;
					drawInfo();
				}
				requestAnimationFrame(animate);
			})();

		}

	</script>
</head>

<body onload="onLoad()">
	<canvas id="ns_canvas"></canvas>
	<style>
		* {
			margin: 0;
			padding: 0;
			background-color: #1E1E1E;
		}
	</style>
</body>

</html>