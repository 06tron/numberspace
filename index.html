<!DOCTYPE html>
<!-- Author: Matthew Richardson -->
<html>

<head>
	<title>Number Space</title>
	<script src="square_mesh_nav.js"></script>
	<script src="sudoku_board.js"></script>
	<script src="vertex_arrays.js"></script>
	<script>

		function onLoad() {

			const canvas = document.getElementById("ns_canvas");
			const context = canvas.getContext("2d");

			canvas.width = innerWidth;
			canvas.height = innerHeight;

			const mouse = { x: 0, y: 0 };

			canvas.onmousemove = function (event) {
				mouse.x = event.clientX;
				mouse.y = event.clientY;
			};

			const b1 = regionS2([4, 0, 0, 0]);
			const b2 = regionS2([0, 1, 0, 0]);
			b1.linkTo(b2, 0, 2);
			b1.linkTo(b2, 3, 0);

			const len = 200;
			const sx = canvas.width / 2 - len;
			const sy = canvas.height / 2 - len;
			let cellX = 0;
			let cellY = 0;
			// const xLim = Math.ceil(sx / len);
			// const yLim = Math.ceil(sy / len);
			const walk = walkS2(b1, getOri(0));
			let onTile = false;
			const xAxis = { a: { x: 0, y: 0 }, b: { x: 1, y: 0 } };
			const yAxis = { a: { x: 0, y: 0 }, b: { x: 0, y: 1 } };

			function drawScene() {
				const dx = Math.floor(2 * (mouse.x - sx) / len) - cellX;
				const dy = Math.floor(2 * (mouse.y - sy) / len) - cellY;
				if (onTile) {
					if (dx != 0) {
						if (walk.attempt(dx > 0 ? 0 : 1)) {
							cellX += Math.sign(dx);
						} else {
							onTile = false;
						}
					} else if (dy != 0) {
						if (walk.attempt(dy > 0 ? 2 : 3)) {
							cellY += Math.sign(dy);
						} else {
							onTile = false;
						}
					}
				} else if (dx == 0 && dy == 0) {
					onTile = true;
				}
				const pTL = { x: sx + Math.floor(cellX / 2) * len, y: sy + Math.floor(cellY / 2) * len };
				const limits = [2, 2, 2, 2];
				if (onTile) {
					tileTree(walk.tileWalk(), pTL, mouse, len, limits, context);
				} else {
					const mid = { x: pTL.x + len / 2, y: pTL.y + len / 2 };
					tileTree(walk.tileWalk(), pTL, mid, len, limits, context);
				}
			}

			canvas.onclick = function (event) {
				onTile = false;
				cellX &= 1;
				cellY &= 1;
			};

			window.addEventListener("keydown", function (event) {
				switch (event.key) {
					case 'd': debugMode = !debugMode; break;
					case 'n': walk.clear(); break;
					case 'm': walk.write(0); break;
					case ',': walk.write(1); break;
					case '.': walk.write(2); break;
					case '/': walk.write(3);
				}
			});

			const times = [];
			let fps;

			function drawInfo() {
				const str = "(" + cellX + ", " + cellY + ") fps: " + fps;
				context.fillStyle = "white";
				context.fillText(str, canvas.width - 100, 20);
			}

			(function animate() {
				context.clearRect(0, 0, canvas.width, canvas.height);
				drawScene();
				if (debugMode) {
					const now = performance.now();
					while (times.length > 0 && times[0] <= now - 1000) {
						times.shift();
					}
					times.push(now);
					fps = times.length;
					drawInfo();
				}
				requestAnimationFrame(animate);
			})();

		}

	</script>
</head>

<body onload="onLoad()">
	<canvas id="ns_canvas"></canvas>
	<style>
		* {
			margin: 0;
			padding: 0;
			background-color: #1E1E1E;
		}
	</style>
</body>

</html>